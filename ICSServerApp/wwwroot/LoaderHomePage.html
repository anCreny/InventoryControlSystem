<!DOCTYPE html>
<html lang="en" style="overflow: hidden">
<head>
    <meta charset="UTF-8">
    <title>Оператор погрузчика</title>
    <style>
        *{
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            transition: 0.3s;
        }
        
        .wrapper{
            display: block;
            position: absolute;
            height: 100%;
            width: 100%;
        }

        .header{
            top: 0;
            position: relative;
            margin-bottom: 15px;
            background-color: #b2b2b2;
            width: 100%;
            height: 10%;
            display: inline-flex;
            align-items: center;
            justify-content: space-between;
        }

        .logoutBtn{
            position: relative;
            right: 0;
            margin: 15px;
            border-radius: 10px;
            border: 0;
            background-color: #b2b2b2;
            padding: 7px;
            font-size: 25px;
        }

        .logoutBtn:hover{
            scale: 110%;
            background-color: grey;
            cursor: pointer;
        }

        .tasksLabelHolder{
            width: 100%;
            height: 7%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px grey solid;
        }

        .tasksHolder{
            width: 97%;
            height: 90%;
            margin: 20px;
            display: flex;
            flex-wrap: wrap;
            border-radius: 0;
            scale: 100%;
        }

        .taskHolder {
            width: 20%;
            height: 15em;
            margin: 30px;
        }

        .taskHolder:hover{
            cursor: pointer;
            scale: 110%;
        }

        .taskHolder:active{
            scale: 95%;
        }

        .taskKeeper {
            margin-left: auto;
            margin-right: auto;
            height: 12%;
            width: 90%;
            top: 0;
            border-top-right-radius: 10px;
            border-top-left-radius: 10px;
            border-top: 2px solid gray;
            border-left: 2px solid gray;
            border-right: 2px solid gray;
            background-color: #d7d7d7;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }


        .taskBody {
            height: 85%;
            width: 100%;
            bottom:0;
            border-radius: 10px;
            border: 2px solid gray;
            background-color: #d7d7d7;
            align-items: end;
            justify-content: center;
        }

        .productsHolder {
            margin-right: auto;
            margin-left: auto;
            margin-bottom: 10px;
            width: 85%;
            height: 75%;
            top: 0;
            border-radius: 10px;
            background-color: #efefef;
            position: relative;
        }

        .descriptionHolder {
            margin-right: auto;
            margin-left: auto;
            height: 15%;
            top: 0;
            margin-top: 7px;
            width: 70%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .descTime{
            border-right: 1px solid black;
        }

        .descField {
            width: 50%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .descType{
            border-left: 1px solid black;
        }

        .productHolder {
            display: inline-flex;
            align-items: center;
            margin: 7px;
        }

        .popupTaskInfoHolder{
            position: absolute;
            height: 100%;
            width: 100%;
            background-color: rgb(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .popupTaskInfoWindow{
            position: relative;
            width: 50%;
            height: 80%;
            border-radius: 15px;
            border: 2px solid gray;
            background-color: #d7d7d7;
        }

        .taskInfoField{
            margin-left: auto;
            margin-right: auto;
            display: block;
            position: relative;
            width: 90%;
            height: 13%;
            margin-top: 20px;
        }

        .taskInfoFieldLabel{
            font-size: 25px;
            border-bottom: 2px solid gray;
            width: 100%;
            height: 30%;
            text-align: center;
            top: 0;
            display: flex;
            justify-content: center;
            align-items: end;
        }

        .taskInfoFieldValue{
            font-size: 20px;
            padding: 10px;
            bottom: 0;
            width: 100%;
            height: 70%;
            position: relative;
            border-bottom-right-radius: 15px;
            border-bottom-left-radius: 15px;
            background-color: #efefef;
        }
        
        .taskInfoButtonsHolder{
            margin-top: 35px;
            position: relative;
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 10%;
            width: 100%;
        }
        
        .taskInfoBtnTake{
            position: relative;
            height: 80%;
            width: 40%;
            border-radius: 15px;
            border: 2px solid gray;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #0ab20a;
            font-size: 25px;
        }
        
        .taskInfoBtnTake:hover{
            background-color: #0fe30f;
            scale: 105%;
            cursor: pointer;
        }
        
        .taskInfoBtnTake:active{
            background-color: #0ab20a;
            scale: 95%;
        }
        
        .taskInfoBtnClose{
            position: relative;
            height: 80%;
            width: 40%;
            border-radius: 15px;
            border: 2px solid gray;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #bb2d3b;
            font-size: 25px;
        }
        
        .taskInfoBtnClose:hover{
            background-color: #dc3545;
            scale: 105%;
            cursor: pointer;
        }

        .taskInfoBtnClose:active{
            background-color: #bb2d3b;
            scale: 95%;
        }
        
        .taskDoingZoneHolder{
            width: 50%;
            height: 100%;
        }
        
        .taskDoingHolder{
            height: 85%;
            width: 100%;
            display: flex;
        }
        
        .taskDoingZoneLeftLabelHolder{
            width: 100%;
            height: 20%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .taskDoingZoneLeftValueLabel{
            height: 20%;
            width: 40%;
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 2px solid gray;
            font-size: 40px;
        }
        
        .taskDoingZoneLeftPickHolder{
            height: 60%;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .taskDoingZoneLeftPickWindow{
            width: 50%;
            height: 100%;
            border-radius: 10px;
            border: 2px solid gray;
            overflow: hidden;
        }
        
        .taskDoingZoneLeftPickWindowImageHolder{
            width: 100%;
            height: 60%;
            justify-content: center;
            align-items: center;
            display: flex;
            top: 0;
        }
        
        .taskDoingZoneLeftPickWindowImageHolder > img{
            max-width: 40%;
        }
        
        .taskDoingZoneLeftPickWindowAddressHolder{
            height: 20%;
            width: 100%;
            justify-content: center;
            align-items: center;
            display: flex;
            font-size: 40px;
            background-color: #d7d7d7;
            border-top: 2px solid gray;
            border-bottom: 2px solid gray;
        }
        
        .taskDoingZoneLeftPickWindowBtn{
            height: 20%;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #0ab20a;
            font-size: 40px;
        }
        
        .taskDoingZoneLeftPickWindowBtn:hover{
            background-color: #0fe30f;
            cursor: pointer;
        }
        
        .taskDoingZoneLeftPickWindowBtn:active{
            background-color: #0ab20a;
            scale: 95%;
        }

        .mapHolder {
            width: 100%;
            height: 60%;
            justify-content: center;
            align-items: center;
            display: flex;
        }

        .tableCell{
            height: 100%;
            width: 100%;
            position: relative;
            transition: 0s;
            display: flex;
            justify-content: center;
            align-items: center;
            outline: 2px solid #0a53be;
        }

        .tableCellIgnore{
            height: 100%;
            width: 100%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .tableCell:hover{
            scale: 100%;
            cursor: pointer;
            outline: 2px solid black;
        }

        .tableCell:active{
            scale: 95%;
            outline: 2px solid black;
        }

        table{
            width: 50%;
            height: 100%;
        }
        tr{
            text-align: center;
        }

        td{
            max-width: 10px;
        }

        tr th{
            font-size: 30px;
        }
    </style>
</head>
<body>
<div class="wrapper">
    <div class="header">
        <div></div>
        <div style="display: inline-flex">
            <h2 style="margin-left: 50px; font-size: 30px; padding: 7px; background-color: #fde910; border-bottom-left-radius: 15px; border-top-right-radius: 15px">Оператор погрузчика</h2>
        </div>
        <div onclick="logout()" class="logoutBtn" style="right: 0">Выход</div>
    </div>
    <div id="tasksHolder" class="tasksHolder" style="display: none">
        <div class="taskHolder">
            <div class="taskKeeper">Не взята</div>
            <div class="taskBody">
                <div class="descriptionHolder">
                    <div class="descTime descField">13:40</div>
                    <div class="descType descField"><img src="icons/Output.png" style="max-width: 20%"></div>
                </div>
                <div class="productsHolder">
                    <div  class="productHolder">
                        <img src="icons/wood.png" style="max-width: 20%">
                        X 4
                    </div>
                    <div  class="productHolder">
                        <img src="icons/varnish.png" style="max-width: 20%">
                        X 0
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="taskDoingHolder" id="taskDoing" style="display: none">
        <!-- Left side -->
        <div class="taskDoingZoneHolder">
            <div class="taskDoingZoneLeftLabelHolder">
                <div id="time" class="taskDoingZoneLeftValueLabel">9:00</div>
            </div>
            <div class="taskDoingZoneLeftLabelHolder">
                <div id="type" class="taskDoingZoneLeftValueLabel">Загрузка</div>
            </div>
            <div class="taskDoingZoneLeftPickHolder">
                <div class="taskDoingZoneLeftPickWindow">
                    <div id="productImg" class="taskDoingZoneLeftPickWindowImageHolder">
                        
                    </div>
                    <div id="cellAddress" class="taskDoingZoneLeftPickWindowAddressHolder">-</div>
                    <div onclick="GetCellDone()" class="taskDoingZoneLeftPickWindowBtn">Отметить</div>
                </div>
            </div>
        </div>
        <div class="taskDoingZoneHolder">
            <div class="mapHolder">
                <table id="map">
                    <tr>
                        <td></td>
                        <th>A</th>
                        <th>B</th>
                        <th>C</th>
                        <th>D</th>
                        <th>E</th>
                        <td></td>
                    </tr>
                    <tr>
                        <th>1</th>
                        <td id="A1"></td>
                        <td id="B1"></td>
                        <td id="C1"></td>
                        <td id="D1"></td>
                        <td id="E1"></td>
                        <td></td>
                    </tr>
                    <tr>
                        <th>2</th>
                        <td id="A2"></td>
                        <td id="B2"></td>
                        <td id="C2"></td>
                        <td id="D2"></td>
                        <td id="E2"></td>
                        <td></td>
                    </tr>
                    <tr>
                        <th>3</th>
                        <td id="A3"></td>
                        <td id="B3"></td>
                        <td id="C3"></td>
                        <td id="D3"></td>
                        <td id="E3"></td>
                        <td></td>
                    </tr>
                    <tr>
                        <th>4</th>
                        <td id="A4"></td>
                        <td id="B4"></td>
                        <td id="C4"></td>
                        <td id="D4"></td>
                        <td id="E4"></td>
                        <td></td>
                    </tr>
                    <tr>
                        <th>5</th>
                        <td id="A5"></td>
                        <td id="B5"></td>
                        <td id="C5"></td>
                        <td id="D5"></td>
                        <td id="E5"></td>
                        <td></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    
</div>
<div id="popup" class="popupTaskInfoHolder" style="display: none">
    <div class="popupTaskInfoWindow">
        <div class="taskInfoField">
            <div class="taskInfoFieldLabel">Время начала задачи</div>
            <div id="timeHolder" class="taskInfoFieldValue"></div>
        </div>
        <div class="taskInfoField">
            <div class="taskInfoFieldLabel">Тип задачи</div>
            <div id="typeHolder" class="taskInfoFieldValue"></div>
        </div>
        <div class="taskInfoField">
            <div class="taskInfoFieldLabel">Объем задачи</div>
            <div id="productsHolder" class="taskInfoFieldValue"></div>
        </div>
        <div class="taskInfoField">
            <div class="taskInfoFieldLabel">Исполнитель</div>
            <div id="keeperHolder" class="taskInfoFieldValue"></div>
        </div>
        <div class="taskInfoField">
            <div class="taskInfoFieldLabel">Ячейки, задействуемые в задаче</div>
            <div id="cellsHolder" class="taskInfoFieldValue"></div>
        </div>
        <div class="taskInfoButtonsHolder">
            <div onclick="pickTask()" class="taskInfoBtnTake">Взять</div>
            <div  onclick="hideTaskInfo()" class="taskInfoBtnClose">Назад</div>
        </div>
    </div>
</div>
</body>
<script>
    let choiceTask = null;
    
    let pickedCell = null;
    
    let taskId = 0;
    
    let taskType = 0;
    
    let cellsCount = 0;
    
    async function logout(){
        const response = await fetch("Api/Logout", {
            method: "POST"
        })

        if (response.ok === true){
            location.reload();
        }
    }

    takePath();

    async function showTaskInfo(task){
        choiceTask = task;
        
        const popup = document.getElementById("popup");
        popup.removeAttribute("style");

        const timeHolder = document.getElementById("timeHolder");
        timeHolder.innerText = task.startTime;

        const typeHolder = document.getElementById("typeHolder");
        if (task.type === 0){
            typeHolder.innerText = "Задача по загрузке товара на склад"
        }
        else{
            typeHolder.innerText = "Задача по выгрузке товара со склада";
        }

        const productsHolder = document.getElementById("productsHolder");
        let productsStringValue = "";
        if (task.wood > 0){
            productsStringValue += "Поддоны с древесиной Х " + task.wood.toString() + "\n";
        }
        if (task.paintsNVarnishes > 0){
            productsStringValue += "Поддоны с лакокрасочными материалами X " + task.paintsNVarnishes.toString();
        }

        productsHolder.innerText = productsStringValue;

        const taskKeeper = document.getElementById("keeperHolder");

        if (task.staffId === null){
            taskKeeper.innerText = "Никто пока не назначен на эут задачу";
        }
        else{
            taskKeeper.innerText = (await getUser(task.staffId))?.fullName;
        }

        const cells = document.getElementById("cellsHolder");
        for (const cell of task.accordedCells) {
            const address = cell.li + cell.ni;
            cells.innerText += "[" + address + "] ";
        }
    }
    
    async function pickTask(){
        const userId = document.cookie.split(" ")[2].split("=")[1];
        
        choiceTask.staffId = userId;
        const response = await fetch("Api/UpdateGoal", {
            method: "POST",
            headers: {"Content-Type" : "application/json"},
            body: JSON.stringify(choiceTask)
        })
        
        if (response.ok){
            hideTaskInfo();
            await takePath();
        }
        
    }

    function clearTable(){
        const letters = ['A','B','C','D','E'];
        for (const letter of letters) {
            for (let i = 1; i < 6; i++){
                const td = document.getElementById(letter + i.toString());
                td.innerHTML = "";
            }
        }
    }
    
    async function GetCells(){
        const response = await fetch("Api/GetCell/", {
            method: "GET",
            headers: {"Accept": "application/json"}
        })

        if (response.ok === true){
            return await response.json();
        }
    }
    
    function pickCell(cell){
        const cellAddress = document.getElementById("cellAddress")
        cellAddress.innerText = cell.li + cell.ni
        
        const cellImage = document.createElement("img");
        switch (cell.productType){
            case 0:
                cellImage.src = "icons/wood.png"
                break;
            case 1:
                cellImage.src = "icons/varnish.png"
                break;
        }
        
        const cellImageHolder = document.getElementById("productImg");
        cellImageHolder.innerHTML = "";
        cellImageHolder.append(cellImage);
        
        pickedCell = cell;
    }
    
    async function GetCellDone(){
        if (pickedCell !== null){
            switch (taskType){
                case 0:
                    pickedCell.cellStatus = 0
                    break;
                case 1:
                    pickedCell.cellStatus = 2
                    break;
            }
            
            
            const response = await fetch("Api/UpdateCell", {
                method: "POST",
                headers: {"Content-Type" : "application/json"},
                body: JSON.stringify(pickedCell)
            })
            
            if (response.ok){
                wipeChoice();
                await UpdateTable();
                cellsCount--;
                if (cellsCount <= 0){
                    console.log("Маркерим гоал");
                    await MarkGoal();
                }
            }
            else{
                console.log()
            }
        }
    }
    
    async function MarkGoal(){
        console.log(taskId);
        const response = await fetch(`Api/MarkGoalDone?id=${taskId}`);
        
        if (response.ok){
            await takePath();
        }
        else{
            console.log("не окей");
        }
    }
    
    function wipeChoice(){
        const address = document.getElementById("cellAddress");
        address.innerText = "-";
        
        const cellImg = document.getElementById("productImg");
        cellImg.innerHTML = "";
        
        pickedCell = null;
    }

    async function ReloadTasks(){
        const tasksHolder = document.getElementById("tasksHolder");
        tasksHolder.innerHTML = "";

        const tasks = await getTasks();
        for (const task of tasks) {
            let taskHolderDiv = document.createElement("div");
            taskHolderDiv.classList.add("taskHolder");

            taskHolderDiv.addEventListener("click", f => showTaskInfo(task));

            let taskKeeperDiv = document.createElement("div");
            taskKeeperDiv.classList.add("taskKeeper");
            console.log(task.staffId);
            
            taskKeeperDiv.innerText = "Не назначена";

            taskHolderDiv.append(taskKeeperDiv);

            let taskBodyDiv = document.createElement("div");
            taskBodyDiv.classList.add("taskBody");

            let descHolderDiv = document.createElement("div");
            descHolderDiv.classList.add("descriptionHolder");

            let timeTaskHolderDiv = document.createElement("div");
            timeTaskHolderDiv.classList.add("descTime", "descField");
            timeTaskHolderDiv.innerText = task.startTime;

            descHolderDiv.append(timeTaskHolderDiv);

            let typeTaskHolderDiv = document.createElement("div");
            typeTaskHolderDiv.classList.add("descType", "descField");
            let typeImg = document.createElement("img");
            if (task.type === 0){
                typeImg.src = "icons/Input.png";
            }
            else{
                typeImg.src = "icons/Output.png";
            }
            typeImg.setAttribute('style',"max-width: 20%");

            typeTaskHolderDiv.append(typeImg);

            descHolderDiv.append(typeTaskHolderDiv);

            taskBodyDiv.append(descHolderDiv);

            let productsHolderDiv = document.createElement("div");
            productsHolderDiv.classList.add("productsHolder");
            if (task.wood > 0){
                let productHolderDiv = document.createElement("div");
                productHolderDiv.classList.add("productHolder");

                let productImg = document.createElement("img");
                productImg.src = "icons/wood.png";
                productImg.setAttribute('style',"max-width: 20%");
                productHolderDiv.append(productImg);

                let valueProductH2 = document.createElement("h2");
                valueProductH2.innerText = "X " + task.wood.toString();

                productHolderDiv.append(valueProductH2);

                productsHolderDiv.append(productHolderDiv);
            }

            if (task.paintsNVarnishes > 0){
                let productHolderDiv = document.createElement("div");
                productHolderDiv.classList.add("productHolder");

                let productImg = document.createElement("img");
                productImg.src = "icons/varnish.png";
                productImg.setAttribute('style',"max-width: 20%");
                productHolderDiv.append(productImg);

                let valueProductH2 = document.createElement("h2");
                valueProductH2.innerText = "X " + task.paintsNVarnishes.toString();

                productHolderDiv.append(valueProductH2);

                productsHolderDiv.append(productHolderDiv);
            }

            taskBodyDiv.append(productsHolderDiv);

            taskHolderDiv.append(taskBodyDiv);

            if (task.staffId === null){
                tasksHolder.append(taskHolderDiv);
            }
        }
    }
    
    async function takePath(){
        const userId = document.cookie.split(" ")[2].split("=")[1];
        const userTask = await getUserTask(userId);
        if (userTask === null){
            showChooseTaskPage()
        }
        else{
            await showTaskDoingPage(userTask)
        }
    }

    function showChooseTaskPage(){
        ReloadTasks()
        
        const taskDoing = document.getElementById("taskDoing");
        taskDoing.setAttribute("style", "display: none");
        
        const tasksHolder = document.getElementById("tasksHolder");
        tasksHolder.removeAttribute("style");
    }
    
    async function showTaskDoingPage(userTask){
        taskId = userTask.id
        await UpdateTable(userTask);
        
        taskType = userTask.type
        
        const timeHolder = document.getElementById("time")
        timeHolder.innerText = userTask.startTime
        
        const typeHolder = document.getElementById("type")
        
        switch (userTask.type){
            case 0:
                typeHolder.innerText = "Загрузка"
                break;
            case 1:
                typeHolder.innerText = "Выгрузка"
                break;
        }
        
        
        
        const tasksHolder = document.getElementById("tasksHolder");
        tasksHolder.setAttribute("style", "display: none");

        const taskDoing = document.getElementById("taskDoing");
        taskDoing.removeAttribute("style");
    }
    
    async function getUserTask(userId){
        const response = await fetch(`Api/GetUserGoal?userid=${userId}`,{
            method: "GET",
            headers: {"Accept" : "application/json"}
        })
        
        if (response.status === 200){
            return await response.json();
        }
        else{
            return null;
        }
    }

    async function getTasks(){
        const response = await fetch("/Api/GetGoal/",{
            method: "GET",
            headers: {"Accept" : "application/json"}
        })

        if (response.ok === true){
            return await response.json();
        }
    }

    function hideTaskInfo(){
        choiceTask = null;
        
        const popup = document.getElementById("popup");
        popup.setAttribute("style", "display:none");

        const timeHolder = document.getElementById("timeHolder");
        const typeHolder = document.getElementById("typeHolder");
        const productsHolder = document.getElementById("productsHolder");
        const taskKeeper = document.getElementById("keeperHolder");
        const cells = document.getElementById("cellsHolder");

        timeHolder.innerText = "";
        typeHolder.innerText = "";
        productsHolder.innerText = "";
        taskKeeper.innerText = "";
        cells.innerText = "";
    }

    async function UpdateTable(task){
        if (task === undefined){
            const userId = document.cookie.split(" ")[2].split("=")[1];
            task = await getUserTask(userId);
        }
        
        
        const cells = await GetCells();

        clearTable();
        let cellCounter = 0;
        for (const cell of cells) {
            const id = cell.li.toString() + cell.ni.toString();

            const tableCell = document.getElementById(id);

            const tableCellDiv = document.createElement("div");

            tableCellDiv.classList.add("tableCellIgnore");
            
            for (const accordedCell of task.accordedCells) {
                if (accordedCell.id === cell.id){
                    switch (task.type){
                        case 0:
                            if (cell.cellStatus !== 0){
                                tableCellDiv.classList.remove("tableCellIgnore")
                                tableCellDiv.classList.add("tableCell")
                                tableCellDiv.addEventListener("click", _ => pickCell(cell))
                                cellCounter++;
                                
                            }
                            break;
                        case 1:
                            if (cell.cellStatus !== 2){
                                tableCellDiv.classList.remove("tableCellIgnore")
                                tableCellDiv.classList.add("tableCell")
                                tableCellDiv.addEventListener("click", _ => pickCell(cell))
                                cellCounter++;
                            }
                            break;
                    }
                    break;
                }
            }


            if (cell.type === 1){
                tableCellDiv.setAttribute("style", "background-color: #20c997")
            }
            else if (cell.type === 0){
                tableCellDiv.style.backgroundColor = "#d29617";
                switch (cell.productType){
                    case 0:
                        tableCellDiv.innerText = "Д"
                        break;
                    case 1:
                        tableCellDiv.innerText = "ЛК"
                        break;
                }

                switch (cell.cellStatus){
                    case 0:
                        tableCellDiv.style.backgroundColor = "#d25f17";
                        break;
                    case 1:
                        tableCellDiv.style.backgroundColor = "#91670f";
                        break;
                }
            }
            tableCell.append(tableCellDiv)
        }
        
        cellsCount = cellCounter;
        taskId = task.id;
    }
    
</script>
</html>